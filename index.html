<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Confidential Questionnaire</title>
  <!-- Tailwind CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-/pW5h+/c2nDqQ7Uo2j6dH1Z7rZ9Qlkgs9zFvJr1sQ2V1w0uJt5J1t0OQYQbR2qgYwA4m3A9yC3n3E3rY8rQm7A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- FileSaver for TXT/CSV downloads (optional but convenient) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" integrity="sha512-5x3N8JYwqgDg7q9Y2s7O0w4cYp9+Gv3s1ZrKQw5h2vYV1J+8z0u7aOZp6w1xE4F0P3y2mVv7N5mK9m3Vd2Fq3g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    html { scroll-behavior: smooth; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <main class="max-w-3xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold">Confidential Questionnaire</h1>
      <p class="text-sm text-slate-600 mt-2">Your answers are <strong>not sent anywhere</strong>. Everything happens in your browser. When finished, download a file and send it directly to the recipient.</p>
      <div class="mt-3 text-xs bg-amber-50 border border-amber-200 rounded-lg p-3 text-amber-800">
        <p><strong>Privacy Note:</strong> This page stores nothing and has no analytics. Closing the page clears your answers.</p>
      </div>
    </header>

    <!-- SETTINGS / RECIPIENT INFO (optional) -->
    <section class="mb-6 grid gap-3 md:grid-cols-2">
      <label class="block">
        <span class="text-sm font-medium">Recipient name (optional)</span>
        <input id="recipientName" type="text" class="mt-1 w-full rounded-lg border border-slate-300 p-2" placeholder="e.g., Dr. Jones" />
      </label>
      <label class="block">
        <span class="text-sm font-medium">Recipient email (optional)</span>
        <input id="recipientEmail" type="email" class="mt-1 w-full rounded-lg border border-slate-300 p-2" placeholder="e.g., dr.jones@clinic.example" />
      </label>
    </section>

    <!-- FORM RENDER TARGET -->
    <form id="questionnaire" class="bg-white rounded-2xl shadow p-5 border border-slate-200"></form>

    <!-- ACTIONS -->
    <section class="mt-6 grid gap-3 md:grid-cols-2">
      <button id="downloadPdf" class="rounded-xl bg-indigo-600 text-white px-4 py-3 font-semibold shadow hover:bg-indigo-700">Download PDF</button>
      <div class="grid grid-cols-2 gap-3">
        <button id="downloadTxt" class="rounded-xl bg-slate-800 text-white px-4 py-3 font-semibold shadow hover:bg-slate-900">Download TXT</button>
        <button id="downloadCsv" class="rounded-xl bg-slate-800 text-white px-4 py-3 font-semibold shadow hover:bg-slate-900">Download CSV</button>
      </div>
      <button id="composeEmail" class="rounded-xl bg-slate-200 text-slate-900 px-4 py-3 font-semibold shadow hover:bg-slate-300">Open Email to Recipient</button>
      <button id="resetForm" class="rounded-xl bg-white border border-slate-300 px-4 py-3 font-semibold shadow hover:bg-slate-50">Clear All Answers</button>
    </section>

    <footer class="mt-8 text-xs text-slate-500">
      <p>Tip: You can customize the questionnaire by editing the <code>SCHEMA</code> below in this file.</p>
    </footer>
  </main>

  <script>
    // ---------------------------
    // 1) Define your questionnaire
    // ---------------------------
    // You can replace this with your own items. For standardized instruments,
    // avoid using the publisher's copyrighted text verbatim unless you have permission.
    const SCHEMA = {
      title: "Behavior & Attention â€“ Informant Questionnaire",
      intro: "Please answer honestly. There are no right or wrong answers.",
      respondentFields: [
        { id: "r_name", label: "Your Full Name", type: "text", required: true },
        { id: "r_relationship", label: "Relationship to Patient", type: "text", required: true },
        { id: "r_email", label: "Your Email (optional)", type: "email" }
      ],
      items: [
        {
          id: "q1",
          text: "Fails to give close attention to details or makes careless mistakes in his/her work or other activities.",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q2",
          text: "Has difficulty sustaining his/her attention in tasks or fun activities..",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q3",
          text: "Doesn't listen when spoken to directly.",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q4",
          text: "Doesn't follow through on instructions and fails to finish work or chores.",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q5",
          text: "Has difficulty organizing tasks or activities.",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q6",
          text: "Avoids, dislikes, or is reluctant to engage in tasks that require sustained mental effort.",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q7",
          text: "Loses things necessary for tasks or activities.",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q8",
          text: "Is easily distracted by extraneous stimuli or irrelevant thoughts.",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q9",
          text: "Is forgetful in daily activities.",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q10",
          text: "Fidgets with hands or feet or squirms in seat.",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q11",
          text: "Leaves his/her seat in classrooms or in other situations in which remaining seated is expected.",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q12",
          text: "Shifts around excessively or feels restless or hemmed in.",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q13",
          text: "Has difficulty engaging in leisure activities quietly (feels uncomfortable, or is loud or noisy).",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q14",
          text: "Is 'on the go' or acts as if 'driven by a motor' (or he/she feels like he/she has to be busy or always doing something).",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q15",
          text: "Talks excessively (in social situations).",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q16",
          text: "Blurts out answers before questions have been completed, completes others' sentences, or jumps the gun.",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q17",
          text: "Has difficulty awaiting his/her turn.",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q18",
          text: "Interrupts or intrudes on others (butts into conversations or activities without permission or takes over what others are doing).",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q19",
          text: "Is prone to daydreaming when he/she should be concentrating on something or working.",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q20",
          text: "Has trouble staying alert or awake in boring situations.",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q21",
          text: "Is easily confused.",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q22",
          text: "Is easily bored.",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q23",
          text: "Is spacey or 'in a fog'.",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q24",
          text: "Is lethargic, more tired than others.",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q25",
          text: "Is underactive or has less energy than others.",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q26",
          text: "Is slow moving.",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        },
        {
          id: "q27",
          text: "Doesn't seem to process information as quickly or as accurately as others.",
          type: "likert",
          options: ["Never/Rarely", "Sometimes", "Often", "Very Often"],
          required: true
        }
      ]
    };

    // ---------------------------
    // 2) Render form from SCHEMA
    // ---------------------------
    const formEl = document.getElementById('questionnaire');

    function el(tag, attrs={}, children=[]) {
      const e = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v]) => {
        if (k === 'class') e.className = v; else if (k === 'for') e.htmlFor = v; else e.setAttribute(k, v);
      });
      children.forEach(c => e.append(c));
      return e;
    }

    function render() {
      formEl.innerHTML = '';
      const title = el('h2', { class: 'text-2xl font-bold mb-1' }, [SCHEMA.title]);
      const intro = el('p', { class: 'text-sm text-slate-600 mb-4' }, [SCHEMA.intro]);

      const respondentBox = el('div', { class: 'mb-6 grid md:grid-cols-3 gap-3' });
      SCHEMA.respondentFields.forEach(f => {
        const wrap = el('label', { class: 'block' });
        wrap.append(el('span', { class: 'text-sm font-medium' }, [f.label]));
        const input = f.type === 'textarea' ? el('textarea', { id: f.id, class: 'mt-1 w-full rounded-lg border border-slate-300 p-2', required: f.required || false })
          : el('input', { id: f.id, type: f.type || 'text', class: 'mt-1 w-full rounded-lg border border-slate-300 p-2', required: f.required || false });
        wrap.append(input);
        respondentBox.append(wrap);
      });

      const itemsBox = el('div', { class: 'grid gap-4' });
      SCHEMA.items.forEach((q, idx) => {
        const card = el('div', { class: 'border border-slate-200 rounded-xl p-4 bg-slate-50' });
        card.append(el('div', { class: 'text-sm font-semibold mb-2' }, [`${idx+1}. ${q.text}`]));

        if (q.type === 'likert') {
          const row = el('div', { class: 'flex flex-wrap gap-3' });
          q.options.forEach((opt, i) => {
            const id = `${q.id}_${i}`;
            const lab = el('label', { class: 'inline-flex items-center gap-2' });
            const radio = el('input', { type: 'radio', name: q.id, id, value: opt, required: q.required || false });
            lab.append(radio, el('span', {}, [opt]));
            row.append(lab);
          });
          card.append(row);
        } else if (q.type === 'textarea') {
          const ta = el('textarea', { id: q.id, rows: 4, class: 'mt-1 w-full rounded-lg border border-slate-300 p-2', required: q.required || false });
          card.append(ta);
        } else if (q.type === 'text') {
          const inp = el('input', { id: q.id, type: 'text', class: 'mt-1 w-full rounded-lg border border-slate-300 p-2', required: q.required || false });
          card.append(inp);
        }
        itemsBox.append(card);
      });

      formEl.append(title, intro, respondentBox, itemsBox);
    }

    render();

    // ---------------------------
    // 3) Collect answers
    // ---------------------------
    function collect() {
      const answers = { meta: {}, items: [] };
      // respondent fields
      SCHEMA.respondentFields.forEach(f => {
        const el = document.getElementById(f.id);
        answers.meta[f.id] = el ? el.value : '';
      });
      // items
      SCHEMA.items.forEach(q => {
        let value = '';
        if (q.type === 'likert') {
          const checked = document.querySelector(`input[name="${q.id}"]:checked`);
          value = checked ? checked.value : '';
        } else if (q.type === 'textarea' || q.type === 'text') {
          const el = document.getElementById(q.id);
          value = el ? el.value : '';
        }
        answers.items.push({ id: q.id, text: q.text, value });
      });
      answers.title = SCHEMA.title;
      answers.timestamp = new Date().toISOString();
      return answers;
    }

    // ---------------------------
    // 4) Download helpers
    // ---------------------------
    function fileBase() {
      const who = (document.getElementById('r_name')?.value || 'respondent').replace(/[^a-z0-9-_]+/gi, '_');
      const ts = new Date().toISOString().replace(/[:.]/g,'-');
      return `${who}_questionnaire_${ts}`;
    }

    function toTxt(a) {
      const lines = [];
      lines.push(`# ${a.title}`);
      lines.push(`Submitted: ${a.timestamp}`);
      lines.push('');
      lines.push(`Respondent: ${a.meta.r_name || ''}`);
      lines.push(`Relationship: ${a.meta.r_relationship || ''}`);
      if (a.meta.r_email) lines.push(`Email: ${a.meta.r_email}`);
      lines.push('\nAnswers:');
      a.items.forEach((it, i) => {
        lines.push(`${i+1}. ${it.text}\n   â†’ ${it.value || '(no answer)'}`);
      });
      return lines.join('\n');
    }

    function toCsv(a) {
      // CSV with columns: index, id, question, answer
      const esc = s => '"' + String(s).replace(/"/g,'""') + '"';
      let rows = [['index','id','question','answer']];
      a.items.forEach((it, i) => rows.push([i+1, it.id, it.text, it.value || '']));
      return rows.map(r => r.map(esc).join(',')).join('\n');
    }

    async function toPdf(a) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'letter' });
      const margin = 48; // 0.67"
      let y = margin;

      doc.setFont('helvetica','bold');
      doc.setFontSize(16);
      doc.text(a.title, margin, y);
      y += 20;

      doc.setFont('helvetica','normal');
      doc.setFontSize(10);
      doc.text(`Submitted: ${new Date(a.timestamp).toLocaleString()}`, margin, y);
      y += 10;
      const metaLines = [
        `Respondent: ${a.meta.r_name || ''}`,
        `Relationship: ${a.meta.r_relationship || ''}`,
        a.meta.r_email ? `Email: ${a.meta.r_email}` : null
      ].filter(Boolean);
      metaLines.forEach(line => { doc.text(line, margin, y); y += 12; });
      y += 6;

      doc.setFont('helvetica','bold');
      doc.text('Answers', margin, y);
      y += 14;

      doc.setFont('helvetica','normal');
      const width = doc.internal.pageSize.getWidth() - margin * 2;
      const lineHeight = 12;

      a.items.forEach((it, i) => {
        const qPrefix = `${i+1}. `;
        const qLines = doc.splitTextToSize(qPrefix + it.text, width);
        qLines.forEach(line => { if (y > 760) { doc.addPage(); y = margin; } doc.text(line, margin, y); y += lineHeight; });
        const aLine = `â†’ ${it.value || '(no answer)'}`;
        if (y > 760) { doc.addPage(); y = margin; }
        doc.text(aLine, margin + 12, y);
        y += lineHeight + 6;
      });

      return doc;
    }

    // ---------------------------
    // 5) Button handlers
    // ---------------------------
    document.getElementById('downloadTxt').addEventListener('click', (e) => {
      e.preventDefault();
      const a = collect();
      const blob = new Blob([toTxt(a)], { type: 'text/plain;charset=utf-8' });
      saveAs(blob, fileBase() + '.txt');
    });

    document.getElementById('downloadCsv').addEventListener('click', (e) => {
      e.preventDefault();
      const a = collect();
      const blob = new Blob([toCsv(a)], { type: 'text/csv;charset=utf-8' });
      saveAs(blob, fileBase() + '.csv');
    });

    document.getElementById('downloadPdf').addEventListener('click', async (e) => {
      e.preventDefault();
      const a = collect();
      const pdf = await toPdf(a);
      pdf.save(fileBase() + '.pdf');
    });

    document.getElementById('composeEmail').addEventListener('click', (e) => {
      e.preventDefault();
      const to = document.getElementById('recipientEmail').value || '';
      const name = document.getElementById('recipientName').value || 'Clinician';
      const subject = encodeURIComponent(`${name}: Questionnaire submission`);
      const body = encodeURIComponent(`Hello ${name},%0D%0A%0D%0AI've completed the questionnaire. The PDF/TXT/CSV file is attached.%0D%0A%0D%0AThank you.`);
      window.location.href = `mailto:${encodeURIComponent(to)}?subject=${subject}&body=${body}`;
    });

    document.getElementById('resetForm').addEventListener('click', (e) => {
      e.preventDefault();
      if (confirm('Clear all answers?')) render();
    });
  </script>
</body>
</html>
